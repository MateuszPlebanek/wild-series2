{% extends 'base.html.twig' %}

{% block title %}{{ program.title }} ‚Äî S{{ season.number }}E{{ episode.number }}{% endblock %}

{% block body %}
  <h1>{{ program.title }}</h1>
  <p>Saison {{ season.number }} ‚Äî √âpisode {{ episode.number }}</p>

  <h2>{{ episode.title }}</h2>
  <p>{{ episode.synopsis }}</p>

  <hr>

  <h3>Commentaires</h3>

  {% if comments is defined and comments|length > 0 %}
      {% for comment in comments %}
          <div class="mb-3">
              <strong>{{ comment.author.email }}</strong>
              ‚Äî Note : {{ comment.rate }}/5<br>
              <small>{{ comment.createdAt|date('d/m/Y H:i') }}</small>
              <p>{{ comment.comment }}</p>

              {# Bouton + modale de suppression, visibles seulement pour admin ou auteur #}
              {% if app.user and (is_granted('ROLE_ADMIN') or app.user == comment.author) %}

                  {# Bouton qui ouvre la modale #}
                  <button
                      type="button"
                      class="btn btn-sm btn-danger"
                      data-bs-toggle="modal"
                      data-bs-target="#deleteCommentModal-{{ comment.id }}"
                  >
                      üóëÔ∏è Supprimer
                  </button>

                  {# Modale Bootstrap sp√©cifique √† ce commentaire #}
                  <div class="modal fade"
                       id="deleteCommentModal-{{ comment.id }}"
                       tabindex="-1"
                       aria-labelledby="deleteCommentModalLabel-{{ comment.id }}"
                       aria-hidden="true">
                      <div class="modal-dialog modal-dialog-centered">
                          <div class="modal-content">
                              <div class="modal-header">
                                  <h5 class="modal-title" id="deleteCommentModalLabel-{{ comment.id }}">
                                      Supprimer ce commentaire ?
                                  </h5>
                                  <button type="button"
                                          class="btn-close"
                                          data-bs-dismiss="modal"
                                          aria-label="Fermer"></button>
                              </div>
                              <div class="modal-body">
                                  Es-tu s√ªr de vouloir supprimer ce commentaire ?
                              </div>
                              <div class="modal-footer">
                                  <button type="button"
                                          class="btn btn-secondary"
                                          data-bs-dismiss="modal">
                                      Annuler
                                  </button>

                                  {# Vrai formulaire de suppression #}
                                  <form method="post"
                                        action="{{ path('program_comment_delete', { id: comment.id }) }}">
                                      <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ comment.id) }}">
                                      <button type="submit" class="btn btn-danger">
                                          Supprimer
                                      </button>
                                  </form>
                              </div>
                          </div>
                      </div>
                  </div>
              {% endif %}
          </div>
          <hr>
      {% endfor %}
  {% else %}
      <p>Aucun commentaire pour cet √©pisode.</p>
  {% endif %}

  {% if app.user and commentForm is not null %}
      <h3>Laisser un commentaire</h3>
      {{ form_start(commentForm) }}
          {{ form_row(commentForm.rate) }}
          {{ form_row(commentForm.comment) }}
          <button class="btn btn-success">Envoyer</button>
      {{ form_end(commentForm) }}
  {% else %}
      <p>
        <a href="{{ path('app_login') }}">Connecte-toi</a> pour laisser un commentaire.
      </p>
  {% endif %}

  <p>
    <a href="{{ path('program_season_show', {
      programSlug: program.slug,
      seasonId:  season.id
    }) }}">‚Üê Retour √† la saison</a>
  </p>
{% endblock %}
